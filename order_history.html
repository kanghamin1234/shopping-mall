<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Order History - Luxury Lobby</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Montserrat:wght@400;500&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Montserrat', sans-serif;
            background-color: #fdfdfd;
            margin: 0;
            padding: 20px;
            color: #333;
        }
        h2, h3, h4 {
            font-family: 'Playfair Display', serif;
        }
        .history-container { max-width: 900px; margin: 40px auto; background: white; padding: 40px; border-radius: 8px; box-shadow: 0 8px 25px rgba(0,0,0,0.08); }
        h2 { text-align: center; margin-bottom: 40px; font-size: 2.5rem; }
        .order-group { border: 1px solid #ddd; border-radius: 8px; margin-bottom: 20px; overflow: hidden; }
        .order-header { background-color: #f9f9f9; padding: 15px 20px; border-bottom: 1px solid #ddd; display: flex; justify-content: space-between; font-weight: 500; cursor: pointer; transition: background-color 0.2s; }
        .order-header:hover { background-color: #f0f0f0; }
        .order-items-container {
            display: none; /* Initially hidden */
            padding: 0 15px;
            background-color: #fff;
        }
        .order-item { display: flex; align-items: center; padding: 15px; border-bottom: 1px solid #eee; }
        .order-item:last-child { border-bottom: none; }
        .order-item img { width: 60px; height: 60px; object-fit: cover; border-radius: 4px; margin-right: 15px; }
        .item-details { flex-grow: 1; }
        .no-history, .back-link { text-align: center; margin-top: 20px; display: block; color: #666; text-decoration: none; transition: color 0.3s ease; }
        .back-link:hover { color: #e0c280; }
        .cancel-btn {
            background-color: #a13d3d;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            margin: 10px 15px 10px 0; float: right;
            transition: background-color 0.3s ease;
        }
        .cancel-btn:hover { background-color: #8a3333; }
        .cancelled-label {
            color: #dc3545;
            font-weight: bold;
            float: right;
            padding: 8px 12px;
            margin: 10px 0;
        }
        .order-group.cancelled {
            background-color: #f8f9fa;
            opacity: 0.7;
        }
        .order-group.cancelled .order-header {
            cursor: default;
        }

        /* 로딩 화면 스타일 */
        #page-loader {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #fdfdfd;
            z-index: 99999;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: opacity 0.5s ease;
        }
        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #eee;
            border-top: 4px solid #333;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <!-- 로딩 화면 요소 추가 -->
    <div id="page-loader">
        <div class="spinner"></div>
    </div>

    <div class="history-container">
        <h2>Order History</h2>
        <div id="order-history-list">
            <!-- Order history will be dynamically inserted here -->
        </div>
        <a href="mypage.html" class="back-link">Back to My Page</a>
    </div>

    <script>
        // 페이지 로드 시 로딩 화면 처리
        window.addEventListener('load', () => {
            const loader = document.getElementById('page-loader');
            // 0.5초 정도 보여주고 페이드아웃
            setTimeout(() => {
                loader.style.opacity = '0';
                setTimeout(() => {
                    loader.style.display = 'none';
                }, 500);
            }, 500);
        });

        const currentUser = localStorage.getItem('currentUser');
        const orderHistoryList = document.getElementById('order-history-list');

        window.onload = function() {
            if (!currentUser) {
                alert('Please log in to view your order history.');
                location.href = 'login.html';
                return;
            }
            renderOrderHistory();
        };

        function renderOrderHistory() {
            const orders = JSON.parse(localStorage.getItem('orders_' + currentUser)) || [];
            orderHistoryList.innerHTML = '';

            if (orders.length === 0) {
                orderHistoryList.innerHTML = '<p class="no-history">You have no past orders.</p>';
                return;
            }

            // Display newest orders first
            orders.reverse().forEach(order => {
                let itemsHtml = '';
                order.items.forEach(item => {
                    itemsHtml += `
                        <div class="order-item">
                            <img src="${item.img}" alt="${item.name}">
                            <div class="item-details">
                                <strong>${item.name}</strong><br>
                                <span>Quantity: ${item.quantity}</span>
                            </div>
                            <span>$${(item.price * item.quantity).toLocaleString()}</span>
                        </div>
                    `;
                });

                const currentStatus = order.status || 'Completed';
                const isCancelled = currentStatus === 'Cancelled';
                const orderGroupClass = isCancelled ? 'order-group cancelled' : 'order-group';
                const headerClickHandler = isCancelled ? '' : `onclick="toggleOrderDetails('${order.orderId}')"`;
                const orderActionHtml = isCancelled
                    ? '<span class="cancelled-label">Cancelled Order</span>'
                    : `<button class="cancel-btn" onclick="cancelOrder('${order.orderId}')">Cancel Order</button>`;

                orderHistoryList.innerHTML += `
                    <div class="${orderGroupClass}">
                        <div class="order-header" ${headerClickHandler}>
                            <span>Order ID: ${order.orderId}</span>
                            <span>Date: ${order.date}</span>
                            <span style="font-weight: bold; color: #e0c280;">${currentStatus}</span>
                            <span>Total: $${order.total.toLocaleString()}</span>
                        </div>
                        <div class="order-items-container" id="items-${order.orderId}">
                            ${itemsHtml}
                            ${orderActionHtml}
                            <div style="clear: both;"></div>
                        </div>
                    </div>
                `;
            });
        }

        function toggleOrderDetails(orderId) {
            const itemsContainer = document.getElementById('items-' + orderId);
            if (itemsContainer.style.display === 'block') {
                itemsContainer.style.display = 'none';
            } else {
                itemsContainer.style.display = 'block';
            }
        }

        function cancelOrder(orderId) {
            if (confirm('Are you sure you want to cancel this order?')) {
                let orders = JSON.parse(localStorage.getItem('orders_' + currentUser)) || [];
                const orderIndex = orders.findIndex(order => order.orderId === orderId);
                if (orderIndex > -1) {
                    orders[orderIndex].status = 'Cancelled'; // 상태를 'Cancelled'로 변경
                }
                localStorage.setItem('orders_' + currentUser, JSON.stringify(orders));
                alert('Order cancelled successfully.');
                renderOrderHistory();
            }
        }
    </script>
</body>
</html>